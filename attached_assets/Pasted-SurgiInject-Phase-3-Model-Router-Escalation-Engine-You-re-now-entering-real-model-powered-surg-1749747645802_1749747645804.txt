SurgiInject: Phase 3 â€” Model Router & Escalation Engine

Youâ€™re now entering real model-powered surgery â€” time to wire up Mistral via Groq (free), and prep for escalation (Mixtral â†’ GPT-4 if weak).

Weâ€™ll:

Route prompts to the best model

Fallback if the response is weak or empty

Plug in Groqâ€™s blazing-fast API for local-first flow

ğŸ§  Prompt 11 â€” mistral_client.py (Groq API Call)
python
Copy
Edit
# Inject into surgiinject/models/mistral_client.py

import os
import requests

GROQ_API_KEY = os.getenv("GROQ_API_KEY")

def run_model(prompt: str) -> str:
    url = "https://api.groq.com/openai/v1/chat/completions"
    headers = {
        "Authorization": f"Bearer {GROQ_API_KEY}",
        "Content-Type": "application/json"
    }
    payload = {
        "model": "mixtral-8x7b-32768",
        "messages": [
            {"role": "system", "content": "You are a surgical code refactorer. Fix bugs with precision."},
            {"role": "user", "content": prompt}
        ],
        "temperature": 0.2,
        "max_tokens": 2048
    }

    response = requests.post(url, headers=headers, json=payload)
    response.raise_for_status()
    return response.json()['choices'][0]['message']['content']
ğŸ§  Prompt 12 â€” Add Fallback & Escalation to prompty.py
python
Copy
Edit
# Inject into surgiinject/engine/prompty.py

def build_prompt(file_path: str, source_code: str, instruction: str) -> str:
    return f"""ğŸ“„ FILE: {file_path}
ğŸ§  TASK: {instruction.strip()}
ğŸ’¬ CONTEXT:
{source_code}

ğŸš€ INSTRUCTION:
{instruction}
"""
ğŸ§  Prompt 13 â€” .env Setup Instruction (Groq API Key)
markdown
Copy
Edit
# Inject into README.md

## ğŸ”‘ Setup Groq API Access

1. Get your key from https://console.groq.com
2. Add to `.env` file:

    GROQ_API_KEY=sk-...
3. Or export in your terminal:

    export GROQ_API_KEY=sk-...
ğŸ§  Prompt 14 â€” Quality Check Stub (Optional)
python
Copy
Edit
# Inject into surgiinject/engine/quality.py

def is_response_weak(response: str) -> bool:
    return not response.strip() or "no change" in response.lower()
Later we can escalate to GPT-4 if is_response_weak() returns True.

ğŸ§  Prompt 15 â€” CLI Env Safety Net
python
Copy
Edit
# Inject into surgiinject/cli.py

if not os.getenv("GROQ_API_KEY"):
    print("[âŒ] Missing GROQ_API_KEY in environment.")
    exit(1)
âœ… Phase 3 Summary
Feature	Status
Groq model routing	âœ… Done
Prompt formatting	âœ… Done
Fallback-ready	âœ… Staged
Quality scoring	ğŸ•— Next
GPT-4 escalation	ğŸ•— Optional Phase 4
Feedback loop	ğŸ•— Future Phase